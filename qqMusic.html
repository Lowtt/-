<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="icon" href="title.ico" type="img/x-ico" />
	<link rel="stylesheet" href="style.css">
	<title>xxMusic</title>
	<style>
		*{
			padding: 0;
			margin: 0;
		}
	</style>
</head>
<body >
	<audio src="" id="mp4">连audio标签都不支持的浏览器或版本，还不卸载或更新，等着过年呢？</audio>
	<!-- 头部欢迎 -->
	<div id="header">
		<div id="show"></div>
		<h2>欢迎来到XX音乐</h2>
		<!-- 音乐搜索 -->
		<div class="search">
			<p>搜索音乐:
				<input type="text">
				<button class="soso">搜索</button>
			</p>
		</div>
	</div>
	<div id="main">
		<!-- 侧边栏 -->
		<div class="sider">
			<div class="newSong">
					<h3>
						<a href="javascript:;" hidefocus="true" title="新歌首发">巅峰榜·新歌</a>
					</h3>
			</div>
			<!-- 热门榜单 -->
			<div class="hot">
				<h3>
					<a href="javascript:;" hidefocus="true" title="热门榜单">热门榜单<span>△</span></a>
				</h3>
			</div>
			<!-- 热门榜单列表 -->
			<ul class="HotList"></ul>
			<!-- 最新榜单 -->
			<div class="newList">
				<h3>
					<a href="javascript:;" hidefocus="true" title="最新榜单">最新榜单<span>△</span></a>
				</h3>
			</div>
			<!-- 最新榜单列表 -->
			<ul class="NewList"></ul>
		</div>
		<!-- 歌曲展示界面 -->
		<div class="songList">
			<p class="head">
				<span>新歌首发</span>
				<span class="upDateTime"></span>
				<span class="random"><input type="checkbox" id="ok">随机播放</span>
			</p>
			<ul class="display"></ul>
		</div>
	</div>
	<script src="jquery-1.10.2.min.js"></script>
	<script src="newSong.js"></script>
	<script src="createSongSheet.js"></script>
	<script type="text/javascript">
		window.onload = function(){
			var ul = document.querySelectorAll("ul");
			var HotList = ul[0];//热门榜单
			var NewList = ul[1];//最新榜单
			getNewSong();
			let url = "https://api.bzqll.com/music/tencent/hotSongList?key=579621905&categoryId=10000000&limit=20&sortId=";
			getSongDetail("json",url,3,function(data){
				createSongSheet(data,HotList);
			})
			getSongDetail("json",url,2,function(data){
				createSongSheet(data,NewList);
			})
		}
		// console.log($("#show")[0])
		//是否随机播放
		var ok = document.getElementById("ok");
		ok.onclick = function(){
			console.log(this.checked)
		}
		//存储[xx:xx]xx格式歌词
		var arr = [];
		//存储秒数+歌词
		let lrcArr =[];
		//声明是否显示歌词
		var arrHas;
		var mp4 = document.getElementById("mp4");
		var btn = document.querySelector(".soso");
		var input = btn.previousSibling.previousSibling;
		var isTrue = 0;
		var istrue = true;
		function slideDown(Who,span){
			$(Who).slideDown("slow");
			span.style.cssText = "display:inline-block;transform:rotate(180deg);transition:.5s";
		}
		function sildeUp(Who,span){
			$(Who).slideUp("slow");
			span.style.cssText = "display:inline-block;transform:rotate(360deg);transition:.5s";
		}
		function slide(is,Who,span){
			if(is===isTrue){
				if(isTrue%2==0){
					slideDown(Who,span);
					isTrue++;
				}else{
					sildeUp(Who,span);
					isTrue++;
				}
			}else{
				if(istrue){
					slideDown(Who,span);
					istrue = false;
				}else{
					sildeUp(Who,span);
					istrue = true;
				}
			}
			
		}
		{
			let span = document.querySelector(".hot").children[0].children[0].children[0];
			$(".hot").on("click",function(){
				slide(isTrue,".HotList",span);
			}) 
		}
		{
			let span1 = document.querySelector(".newList").children[0].children[0].children[0];
			$(".newList").on("click",function(){
				slide(istrue,".NewList",span1);
			}) 
		}
		//搜索歌曲
		btn.onclick = function(){
			if(input.value){
				soso(input.value);
			}else{
				input.value = prompt("请输入搜索内容");
				soso(input.value)
			}
		}
		//新歌首发展示列表以及对应点击事件(新歌和其它榜单调用的接口不同)
		var newSong = document.querySelector(".newSong");
		newSong.onclick = function(){
			head.children[0].innerHTML = this.children[0].children[0].innerHTML;
			display.textContent = "";
			getNewSong();
		}
		// 获得歌曲详情(包括歌单)
		function getSongDetail(json,url,params,callback1){
			let xhr = function(){
				if(window.XMLHttpRequest){
					return new XMLHttpRequest();
				}else{
					return new ActiveObject("Micrsoft.XMLHttp");
				}
			}();
				xhr.responseType = json;		
				xhr.onreadystatechange = function(){
					if(xhr.readyState===4&&xhr.status=="200"){
						// console.log(xhr.response)
						callback1(xhr.response);
					}
				}
				xhr.open("GET",url+params);
				xhr.send();
		}
		//展示搜索歌曲
		function displaySosoSong(data){
			for(let i=0;i<display.children.length;i++){
				display.children[i].remove();
				i--;
			}
			upDateTime.textContent = "";
			tiTle.innerHTML = input.value;
			data.data.forEach(function(song,index){
				createSongList(song.id,song.name,song.singer,index);
				});	
		}
		//搜索歌曲
		function soso(key){
			let url = "https://api.bzqll.com/music/tencent/search?key=579621905&limit=100&offset=0&type=song&s=";
			getSongDetail("json",url,key,function(data){
				displaySosoSong(data);
			})
		}
		//生成歌曲列表
		function createSongList(contentName,songName,singerName,index){
			let a = document.createElement("a");
				a.href = "javascript:;";
				a.title = "点击播放";
			let content = document.createElement("li");
				content.style.backgroundColor = bgColor();
				content.name = contentName;
				a.textContent = index+1; 
			let songname = document.createElement("h3");
				songname.textContent =songName;
			let singername = document.createElement("span");
				singername.textContent = singerName;
				a.appendChild(songname);
				a.appendChild(singername);
				content.appendChild(a);
				display.appendChild(content);
				content.onclick = function(){
					let url = `https://api.bzqll.com/music/tencent/url?key=579621905&id=${this.name}&br=192`;
					//播放歌曲
					playSong(url);
					// console.log(this.name);
					let Url = "https://api.bzqll.com/music/tencent/lrc?key=579621905&id=";
					getSongDetail("",Url,this.name,function(data){
						// console.log(data,data.indexOf("]"))
						arr.length = 0;
						lrcArr.length = 0;
						let m = 0;
						for(let i=0;i<data.length;i++){
							if(data[i]=="["){
								let re = data.substring(m,i);
								arr.push(re);
								m = i;
							}
						}
						arr.shift();
						let moveExcess = /(ti)+|(ar:)+|(al)+|(by:)+|(offset)+/i;
						for(let i=0;i<arr.length;i++){
							if(moveExcess.test(arr[i])){
								arr.splice(i,1);
								i--;
							}
						}
						if(arrHas){
							$("#show")[0].innerHTML = "";
							clearInterval(arrHas);
							getLrc(arr);
						}else{
							getLrc(arr);
						}
					})
				}
		}
		//获得歌词时间对应内容
		function getLrc(arr){
			var timeReg = /\[\d{2}:\d{2}\.\d{2,}\]/g;
			for (let i=0;i<arr.length;i++){
				var time = arr[i].match(timeReg);
				// console.log(arr,arr[i],time)
				var value = arr[i].replace(timeReg,""); //获取纯歌词文本
				for (let j=0;j<time.length;j++ ) {
					var t = time[j].slice(1, -1).split(":");
					var timeArr = parseInt(t[0], 10) * 60 + parseFloat(t[1]);
					lrcArr.push([timeArr, value]);
				}
			}
			arrHas = setInterval(showLrc, 20);
		}
		//展示歌词
		function showLrc(){
			var curTime = mp4.currentTime;//获取当前的播放时间
			for (let i = 0; i < lrcArr.length; i++) {
				if ((curTime >lrcArr[i][0])&&(curTime<lrcArr[i+1][0])) {
					//播放时间大于对应歌词时间小于下一句歌词时间就显示当前歌词
					document.getElementById("show").innerHTML = lrcArr[i][1];
					break;
				}
			}
    	}
	</script>
</body>
</html>